{% set attr = attr|default({}) %}
{% set provider = provider ?? 'MISSING_PROVIDER' %}
{% set multiple = multiple|default(false) %}
{% set min_chars = min_chars|default(1) %}
{% set debounce = debounce|default(300) %}
{% set limit = limit|default(10) %}
{% set input_class = (attr.class|default('') ~ ' form-control')|trim %}
{% set theme_name = theme ?? 'bootstrap-5' %}

{% set placeholder = attr.placeholder|default(placeholder)|default('Search...') %}

{% set td = (translation_domain is defined ? translation_domain : null) %}
{% set tp = (placeholder_translation_parameters is defined
    ? placeholder_translation_parameters
    : (translation_parameters is defined ? translation_parameters : {}))
%}

{% if td is same as(false) %}
    {% set placeholder_text = placeholder %}
{% elseif td is null %}
    {% set placeholder_text = placeholder|trans(tp) %}
{% else %}
    {% set placeholder_text = placeholder|trans(tp, td) %}
{% endif %}

{% set current_locale = app.request.locale|default('en') %}

{% set sig = autocomplete_sig(
    'autocomplete_search',
    provider,
    theme_name,
    td is same as(false) ? '' : td,
    autocomplete_choice_label is defined ? autocomplete_choice_label : '',
    autocomplete_choice_value is defined ? autocomplete_choice_value : '',
    current_locale
) %}

{% set url_value = path('autocomplete_search', { provider: provider, theme: theme_name }) %}
{% if td is not same as(false) and td is not null and td is not empty %}
    {% set url_value = url_value ~ (url_value matches '/\\?/' ? '&' : '?') ~ 'translation_domain=' ~ td|url_encode %}
{% endif %}
{% if autocomplete_choice_label is defined and autocomplete_choice_label %}
    {% set url_value = url_value ~ (url_value matches '/\\?/' ? '&' : '?') ~ 'choice_label=' ~ autocomplete_choice_label|url_encode %}
{% endif %}
{% if autocomplete_choice_value is defined and autocomplete_choice_value %}
    {% set url_value = url_value ~ (url_value matches '/\\?/' ? '&' : '?') ~ 'choice_value=' ~ autocomplete_choice_value|url_encode %}
{% endif %}
{% set url_value = url_value ~ (url_value matches '/\\?/' ? '&' : '?') ~ 'locale=' ~ current_locale|url_encode %}

{% set url_value = url_value ~ '&ts=' ~ sig.ts ~ '&sig=' ~ sig.sig %}

{% if selected_label is defined and selected_label and td is not same as(false) %}
    {% if td is null %}
        {% set selected_label = selected_label|trans %}
    {% else %}
        {% set selected_label = selected_label|trans({}, td) %}
    {% endif %}
{% endif %}

{% set is_floating = floating_label is defined and floating_label %}

<div class="position-relative"
     data-autocomplete-theme="{{ theme_name }}"
     {% if is_floating %}data-autocomplete-floating{% endif %}
     data-controller="kerrialnewham--autocomplete--ssr-autocomplete"
     data-kerrialnewham--autocomplete--ssr-autocomplete-theme-value="{{ theme_name }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-provider-value="{{ provider }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-multiple-value="{{ multiple ? 'true' : 'false' }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-min-chars-value="{{ min_chars }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-debounce-value="{{ debounce }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-limit-value="{{ limit }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-url-value="{{ url_value }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-name-value="{{ name ends with '[]' ? name|slice(0, -2) : name }}"
     data-kerrialnewham--autocomplete--ssr-autocomplete-target="wrapper">

    {% if multiple %}
        <div class="d-flex flex-wrap gap-1"
             data-kerrialnewham--autocomplete--ssr-autocomplete-target="chipsContainer">
            {% if value is defined and value is iterable %}
                {% for item in value %}
                    {% include '@Autocomplete/theme/bootstrap-5/_chip.html.twig' with {
                        item: item,
                        name: name,
                        translation_domain: td
                    } %}
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}

    <div class="position-relative">
        <input type="text"
               class="{{ input_class }}"
               placeholder="{{ placeholder_text }}"
               {% if not multiple and selected_label is defined and selected_label %}value="{{ selected_label }}"{% endif %}
               autocomplete="off"
               data-kerrialnewham--autocomplete--ssr-autocomplete-target="input"
               data-action="input->kerrialnewham--autocomplete--ssr-autocomplete#onInput focus->kerrialnewham--autocomplete--ssr-autocomplete#onFocus keydown->kerrialnewham--autocomplete--ssr-autocomplete#onKeydown"
        {% for attrName, attrValue in attr %}
        {% if attrName != 'class' and attrName != 'placeholder' %}{{ attrName }}="{{ attrValue }}"{% endif %}
        {% endfor %}>

        {# Loading spinner (Bootstrap) #}
        <span class="position-absolute top-50 end-0 translate-middle-y me-3"
              data-kerrialnewham--autocomplete--ssr-autocomplete-target="loading"
              style="display: none;"
              aria-hidden="true">
            <span class="spinner-border spinner-border-sm text-secondary" role="status"></span>
        </span>

        {# Dropdown menu (Bootstrap) #}
        <div class="dropdown-menu w-100 shadow autocomplete-dropdown bg-white z-3"
             data-kerrialnewham--autocomplete--ssr-autocomplete-target="dropdown"
             role="listbox"
             style="display: none; max-height: 300px; overflow-y: auto;">
            <div class="list-group" data-kerrialnewham--autocomplete--ssr-autocomplete-target="optionsContainer">
            </div>
        </div>
    </div>

    {% if not multiple %}
        <input type="hidden"
               name="{{ name }}"
               value="{{ value.id|default(value|default('')) }}"
               data-kerrialnewham--autocomplete--ssr-autocomplete-target="selectedInput">
    {% endif %}
</div>
